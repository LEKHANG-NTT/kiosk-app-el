<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>QR Scanner</title>
<style>
  body{margin:0;font-family:Segoe UI;background:#000;color:#fff;display:flex;flex-direction:column;height:100vh}
  #video{width:100%;height:calc(100vh - 80px);object-fit:cover}
  #controls{padding:12px}
  #bigout{position:fixed;left:50%;top:18%;transform:translate(-50%,0);background:rgba(0,0,0,0.85);color:#fff;padding:14px 20px;border-radius:8px;font-size:20px;z-index:99999;max-width:90%;text-align:center;display:none}
  #homeBtn{position:fixed;right:16px;bottom:16px;z-index:100000;padding:10px 12px;background:#00f2fe;border:none;border-radius:8px;font-weight:bold;color:#000;cursor:pointer}
</style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <div id="controls">
    <button id="start">Bắt đầu quét</button>
    <button id="stop">Dừng</button>
    <span id="out"></span>
  </div>

  <div id="bigout"></div>
  <button id="homeBtn">Home</button>

  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('video');
    const out = document.getElementById('out');
    const bigout = document.getElementById('bigout');
    const homeBtn = document.getElementById('homeBtn');
    let stream, raf;

    async function start() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        function scan() {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const img = ctx.getImageData(0,0,canvas.width,canvas.height);
            const code = jsQR(img.data, img.width, img.height);
            if (code) {
              out.textContent = 'Detected: ' + code.data;
              // Show large on-screen result
              bigout.style.display = 'block';
              bigout.textContent = code.data;
              // Also post message for backward compatibility (preload can forward)
              window.postMessage({ type: 'qr', data: code.data }, '*');
            }
          }
          raf = requestAnimationFrame(scan);
        }
        scan();
      } catch (e) { out.textContent = 'Camera access failed'; }
    }

    document.getElementById('start').onclick = start;
    document.getElementById('stop').onclick = () => { if (stream) { stream.getTracks().forEach(t=>t.stop()); } if (raf) cancelAnimationFrame(raf); bigout.style.display='none'; };

    homeBtn.onclick = () => {
      // Tell main process we want to go home (will load last page)
      window.postMessage({ type: 'qr-home' }, '*');
    };

  </script>
</body>
</html>